---
name: 単体テスト設計・実装
description: 単体テストの設計・実装・カバレッジ計測を、方針に沿って安全に進めるためのスキル。
---

# 単体テスト設計・実装スキル

## 適用トリガー
次の依頼が来たらこのスキルを適用する。
- 「単体テストを書いて」
- 「テスト設計して」
- 「カバレッジを上げて」
- 「この関数のテストを追加して」

## 実行モード
最初に、次のどれで進めるかを明確にする。
1. `設計のみ`: テスト設計書のみ作成
2. `設計+実装`: 設計書とテストコードを作成
3. `設計+実装+計測`: 設計書とテストコード作成に加えてカバレッジ計測まで実行

指定がない場合は `設計+実装` で進める。

## 基本方針
- 実装を読んで仕様を整理し、前提を固定してからテストを書く。
- テストは決定的にする（同じ入力で同じ結果）。
- 依存（DB/外部API/時間/乱数/環境変数）はモック・スタブで制御する。
- テストはメソッド/関数単位で整理する。
- 不明点は推定で断定しない。必要なら確認し、推定時は「推定」と明記する。

## 重要な制約
- ユーザー承認なしに本体コード（プロダクションコード）を変更しない。
- 本体コードの変更が必要と判断した場合は、理由と最小変更案を提示して承認を得る。
- 生成コード、ベンダーコード、外部依存は原則としてテスト対象から除外する。

## カバレッジ方針
- 目標は固定値ではなく `coverage_target` として扱う（既定値 90%）。
- 指定があればその目標値に従う。
- 100%にできない場合は到達不能行・分岐と理由を示す。
- 目標未達の場合は、追加テスト案または設計改善案を提示する。

## 作業手順
1. 対象コードの公開関数/メソッドと副作用を列挙する。
2. 同値分割、境界値、分岐条件、例外条件を整理する。
3. 先にテスト設計書を作る。
4. テスト実装を行う（必要に応じてテーブルドリブン）。
5. 依存をモック/スタブ化する。
6. `設計+実装+計測` の場合はカバレッジ測定を実施する。
7. 目標未達時は原因分析と追加案を提示する。

## テスト設計フォーマット（必須）
- 大項目: テスト対象メソッド/関数
- 中項目: 正常系 / 準正常系 / 異常系
- 小項目: 各テストケース

各テストケースに含める項目:
- テスト名
- 前提
- 入力
- 期待結果
- どの分岐/境界条件を検証するか

## 出力フォーマット
### 1) テスト設計書
- 対象一覧（関数/メソッド）
- 依存一覧（DB/HTTP/IO/時間など）
- ケース一覧（正常/準正常/異常）

### 2) テストコード
- ファイルパス
- 追加/更新したテストコード

### 3) 計測結果（計測モード時）
- 測定コマンド
- カバレッジ結果要約
- 目標達成可否

### 4) 失敗時レポート（テスト失敗または目標未達時）
- 失敗理由
- 再現手順
- 追加で必要な対応案

## 言語共通ルール
- テスト名は意図が分かる文にする。
- 副作用の有無を検証対象として明示する。
- 実行時間が長すぎるテストは分離し、単体テストとしての責務を保つ。

## Go固有ルール
- `t.Parallel()` はデータ競合がない場合のみ使う。
- 時刻依存は `time.Now()` 直接呼び出しを避け、注入可能にする。
- エラーは `errors.Is` / `errors.As` を優先して検証する。
- サブテストで正常/準正常/異常を整理する。
